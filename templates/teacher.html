<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard — Tuition Centre</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #0f1724;
      --muted: #9aa4b2;
      --card: #0d1720;
      --accent: #6ee7b7;
      --accent-2: #60a5fa;
      --danger: #fb7185;
      --warning: #fbbf24;
      --glass: rgba(255,255,255,0.03);
      --soft: rgba(255,255,255,0.04);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: var(--bg);
      color: #e6eef8;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    .app {
      display: flex;
      height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, #0a1422, #0c1929);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      box-shadow: 6px 0 20px rgba(2,6,23,0.6);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 28px;
    }
    .logo {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      color: #021;
    }
    .brand h1 {
      font-size: 16px;
      margin: 0;
    }
    .menu {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 12px;
    }
    .menu button {
      background: transparent;
      border: 0;
      padding: 12px 14px;
      border-radius: 8px;
      color: var(--muted);
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .menu button:hover {
      background: rgba(255,255,255,0.02);
    }
    .menu button.active {
      background: linear-gradient(90deg, rgba(255,255,255,0.02), transparent);
      color: #fff;
      border-left: 3px solid var(--accent);
    }
    .sidebar-footer {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .search {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--glass);
      padding: 10px 12px;
      border-radius: 10px;
      width: 400px;
    }
    .search input {
      background: transparent;
      border: 0;
      outline: none;
      color: #cfe6ff;
      font-size: 14px;
      width: 100%;
    }
    .user {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: #0b1622;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }

    /* Content */
    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      gap: 20px;
    }
    .col-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .right {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius: 12px;
      padding: 20px;
    }
    .panel h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
    }

    /* KPIs */
    .kpis {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
    }
    .kpi {
      flex: 1;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
    }
    .kpi small {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }
    .kpi strong {
      font-size: 24px;
      font-weight: 700;
    }

    /* Buttons */
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: 0;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: #021;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.04);
      color: var(--muted);
    }
    .btn.danger {
      background: var(--danger);
      color: white;
    }

    /* Widgets */
    .widgets {
      display: flex;
      gap: 16px;
    }
    .donut {
      flex: 1;
    }
    .mini-bar {
      flex: 1;
    }

    /* List items */
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .badge {
      background: var(--accent);
      color: #021;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    /* Small cards */
    .small-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius: 12px;
      padding: 16px;
    }
    .small-card h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: var(--muted);
    }

    /* Hidden utility */
    .hidden {
      display: none !important;
    }

    /* Flash messages */
    .flash-messages {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      max-width: 400px;
    }
    .flash-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .flash-message.success {
      background: var(--accent);
      color: #021;
    }
    .flash-message.error {
      background: var(--danger);
      color: white;
    }
    .flash-message.info {
      background: var(--accent-2);
      color: white;
    }

    /* Teacher actions */
    .teacher-actions {
      display: flex;
      gap: 8px;
    }

    /* Chart containers */
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 20px;
    }
    .chart-container.small {
      height: 150px;
    }

    /* New styles for insights and reports */
    .insights-panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      border-left: 4px solid var(--accent);
    }
    .insight-item {
      padding: 16px;
      margin: 12px 0;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border-left: 3px solid var(--accent-2);
    }
    .insight-item.warning {
      border-left-color: var(--warning);
    }
    .insight-item.danger {
      border-left-color: var(--danger);
    }
    .export-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .export-btn {
      padding: 8px 12px;
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--muted);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .export-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--accent);
    }
    .chart-report {
      background: rgba(255,255,255,0.02);
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 13px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      margin-bottom: 20px;
    }
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Form elements */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-size: 14px;
      color: var(--muted);
    }
    .form-control {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      color: #e6eef6;
      font-size: 14px;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(2,6,23,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal {
      background: var(--panel);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(2,6,23,0.8);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h2 {
      font-size: 18px;
      color: var(--accent);
      margin: 0;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Table styles */
    .table-container {
      margin-top: 16px;
      overflow-x: auto;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      font-size: 12px;
      color: var(--muted);
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .data-table td {
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.02);
    }
    .action-btn {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      margin-right: 4px;
    }
    .action-btn.delete {
      background: rgba(251,113,133,0.1);
      color: var(--danger);
    }

    /* Read-only badge */
    .read-only-badge {
      background: var(--muted);
      color: var(--bg);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 8px;
    }

    /* Settings styles */
    .settings-section {
      margin-bottom: 24px;
    }
    .settings-section h4 {
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 16px;
    }
    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .settings-item:last-child {
      border-bottom: none;
    }
    .settings-item .description {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255,255,255,0.1);
      transition: .3s;
      border-radius: 24px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: var(--bg);
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    /* Profile section */
    .profile-section {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 700;
      color: #021;
    }
    .profile-info h3 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }
    .profile-info p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    /* CSV Upload Modal Styles */
    .csv-upload-section {
      border: 2px dashed rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    .csv-upload-section:hover {
      border-color: var(--accent);
    }
    .csv-upload-section.drag-over {
      border-color: var(--accent);
      background: rgba(110,231,183,0.05);
    }
    .csv-info {
      background: rgba(255,255,255,0.02);
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 13px;
    }
    .csv-structure {
      text-align: left;
      margin-top: 10px;
    }
    .csv-structure ul {
      margin: 10px 0;
      padding-left: 20px;
    }
    .csv-structure li {
      margin-bottom: 5px;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      margin: 15px 0;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-input-label {
      display: inline-block;
      padding: 10px 20px;
      background: var(--accent);
      color: #021;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .file-input-label:hover {
      background: var(--accent-2);
    }
    .current-data-info {
      background: rgba(251,113,133,0.1);
      border: 1px solid rgba(251,113,133,0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .current-data-info h4 {
      color: var(--danger);
      margin: 0 0 10px 0;
    }

    /* View-only notice */
    .view-only-notice {
      background: rgba(96,165,250,0.1);
      border: 1px solid rgba(96,165,250,0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--accent-2);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" role="navigation" aria-label="Main nav">
      <div class="brand">
        <div class="logo">TC</div>
        <div>
          <h1>Tuition Centre</h1>
          <div style="font-size:12px;color:var(--muted)">Teacher Portal</div>
        </div>
      </div>

      <nav class="menu" id="menu">
        <button class="active" data-panel="overview">Overview</button>
        <button data-panel="students">My Students</button>
        <button data-panel="subjects">My Subjects</button>
        <button data-panel="topics">My Topics</button>
        <button data-panel="graph-data">Analytics</button>
        <button data-panel="settings">Settings</button>
        <button onclick="window.location.href='{{ url_for('logout') }}'" style="color: var(--danger);">Logout</button>
      </nav>

      <div class="sidebar-footer">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:13px">Logged as</div>
            <div style="font-weight:600">{{ teacher.full_name.split(' ')[0] }}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:var(--muted)">Today</div>
            <div style="font-weight:600" id="currentDate">Loading...</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <!-- Flash Messages -->
      <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash-message {{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>

      <header class="topbar">
        <div class="search">
          <input id="global-search" placeholder="Search students, topics, tests..." />
        </div>
        <div class="user">
          <div style="text-align:right;margin-right:6px">
            <div style="font-size:13px;color:var(--muted)">{{ teacher.full_name.split(' ')[0] }}</div>
            <div style="font-size:12px;color:var(--muted)">{{ teacher.subjects.split(',')[0] }} Teacher</div>
          </div>
          <div class="avatar">{{ teacher.full_name[0] }}</div>
        </div>
      </header>

      <!-- Overview Panel -->
      <div class="content panel-content" id="overview-panel">
        <div class="col-left">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div>
                <h3>Class Performance Overview</h3>
                <div style="font-size:13px;color:var(--muted)">{{ teacher.subjects }} • Last 90 days</div>
              </div>
              <div class="teacher-actions">
                <button class="btn" id="refreshBtn">Refresh Data</button>
                <button class="btn ghost" id="downloadReport">Export Report</button>
              </div>
            </div>

            <div class="view-only-notice">
              <i class="fas fa-eye"></i> View Only Mode - Data is loaded from system CSV files
            </div>

            <div style="display:flex;gap:16px;margin-bottom:20px" class="kpis">
              <div class="kpi">
                <small>My Students</small>
                <strong id="kpi-students">Loading...</strong>
              </div>
              <div class="kpi">
                <small>My Subjects</small>
                <strong id="kpi-subjects">Loading...</strong>
              </div>
              <div class="kpi">
                <small>Average Score</small>
                <strong id="kpi-avg">Loading...</strong>
              </div>
              <div class="kpi">
                <small>Total Tests</small>
                <strong id="kpi-tests">Loading...</strong>
              </div>
            </div>

            <div class="chart-container">
              <canvas id="areaChart"></canvas>
            </div>

            <!-- Performance Insights -->
            <div class="insights-panel">
              <h4>Performance Insights</h4>
              <div id="performanceInsights">
                <div style="text-align:center;color:var(--muted)">Analyzing performance data...</div>
              </div>
            </div>
          </div>

          <!-- small widgets row -->
          <div style="display:flex;gap:20px">
            <div class="panel" style="flex:1">
              <h3>Performance by Factor</h3>
              <div class="widgets" style="margin-top:16px">
                <div class="panel donut" style="padding:16px">
                  <h4 style="margin:8px 0 12px 0;color:var(--muted);font-size:13px">By Day of Week</h4>
                  <div class="chart-container small">
                    <canvas id="dayChart"></canvas>
                  </div>
                  <div class="chart-report" id="dayReport">
                    Analyzing day performance patterns...
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:16px">
                  <div class="panel mini-bar">
                    <h4 style="margin:0;color:var(--muted);font-size:13px">By Topic</h4>
                    <div class="chart-container small">
                      <canvas id="topicChart"></canvas>
                    </div>
                  </div>
                  <div class="panel mini-bar">
                    <h4 style="margin:0;color:var(--muted);font-size:13px">By Subject</h4>
                    <div class="chart-container small">
                      <canvas id="subjectChart"></canvas>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel" style="width:360px">
              <h3>Quick Stats & Actions</h3>
              <div style="margin-top:16px">
                <div class="list-item">
                  <div>
                    <div style="font-weight:700">Total Tests</div>
                    <div style="font-size:13px;color:var(--muted)">All time</div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-weight:700;color:var(--accent)" id="totalTests">Loading...</div>
                  </div>
                </div>

                <div class="list-item">
                  <div>
                    <div style="font-weight:700">Best Performing Day</div>
                    <div style="font-size:13px;color:var(--muted)">Highest average scores</div>
                  </div>
                  <div style="text-align:right">
                    <div class="badge" id="bestDay">Loading...</div>
                  </div>
                </div>

                <div class="list-item" style="border-bottom:none">
                  <div>
                    <div style="font-weight:700">Most Challenging Topic</div>
                    <div style="font-size:13px;color:var(--muted)">Needs attention</div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-size:13px;color:var(--danger)" id="challengingTopic">Loading...</div>
                  </div>
                </div>

                <!-- Export Options -->
                <div style="margin-top:20px">
                  <h4 style="margin-bottom:12px;color:var(--muted);font-size:13px">Export Reports</h4>
                  <div class="export-options">
                    <button class="export-btn" data-report="performance_summary">Performance Summary</button>
                    <button class="export-btn" data-report="student_progress">Student Progress</button>
                    <button class="export-btn" data-report="comprehensive">Full Data Export</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- right column -->
        <aside class="right">
          <div class="small-card panel">
            <h4>Top Students</h4>
            <div style="margin-top:12px" id="topStudentsList">
              <div style="text-align:center;color:var(--muted)">Loading...</div>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Recent Tests</h4>
            <div style="margin-top:12px" id="recent-tests">
              <div style="text-align:center;color:var(--muted)">Loading...</div>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Performance Factors</h4>
            <div style="margin-top:12px" id="performanceFactors">
              <div style="text-align:center;color:var(--muted)">Loading...</div>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Teaching Recommendations</h4>
            <div style="margin-top:12px" id="systemRecommendations">
              <div style="text-align:center;color:var(--muted)">Loading...</div>
            </div>
          </div>
        </aside>
      </div>

      <!-- My Students Panel -->
      <div class="content panel-content hidden" id="students-panel">
        <div class="col-left">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <h3>My Students</h3>
              <div>
                <button class="btn ghost" id="exportStudentsData">Export Student Data</button>
              </div>
            </div>

            <div class="view-only-notice">
              <i class="fas fa-eye"></i> View Only - Students are loaded from system CSV data
            </div>

            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Student Name</th>
                    <th>Student ID</th>
                    <th>Grade Level</th>
                    <th>Average Score</th>
                    <th>Tests Taken</th>
                    <th>Last Test Date</th>
                  </tr>
                </thead>
                <tbody id="studentsTable">
                  <tr>
                    <td colspan="6" style="text-align:center;color:var(--muted);padding:20px">
                      Loading student data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="right">
          <div class="small-card panel">
            <h4>Student Performance</h4>
            <div class="chart-container small">
              <canvas id="studentPerformanceChart"></canvas>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Grade Distribution</h4>
            <div class="chart-container small">
              <canvas id="gradeDistributionChart"></canvas>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Student Stats</h4>
            <div style="margin-top:12px" id="studentStats">
              <div class="list-item">
                <div>Total Students</div>
                <div id="totalStudentsCount">0</div>
              </div>
              <div class="list-item">
                <div>Above 80%</div>
                <div style="color:var(--accent)" id="above80Count">0</div>
              </div>
              <div class="list-item">
                <div>Below 60%</div>
                <div style="color:var(--danger)" id="below60Count">0</div>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <!-- My Subjects Panel -->
      <div class="content panel-content hidden" id="subjects-panel">
        <div class="col-left">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <h3>My Subjects</h3>
              <div>
                <button class="btn ghost" id="exportSubjectsData">Export Subject Data</button>
              </div>
            </div>

            <div class="view-only-notice">
              <i class="fas fa-eye"></i> View Only - Subjects are loaded from system CSV data
            </div>

            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Subject Name</th>
                    <th>Average Score</th>
                    <th>Total Tests</th>
                    <th>Top Topic</th>
                    <th>Performance Trend</th>
                  </tr>
                </thead>
                <tbody id="subjectsTable">
                  <tr>
                    <td colspan="5" style="text-align:center;color:var(--muted);padding:20px">
                      Loading subject data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="right">
          <div class="small-card panel">
            <h4>Subject Performance</h4>
            <div class="chart-container small">
              <canvas id="subjectPerformanceChart"></canvas>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Subject Comparison</h4>
            <div style="margin-top:12px" id="subjectComparison">
              <div style="text-align:center;color:var(--muted)">Loading comparison...</div>
            </div>
          </div>
        </aside>
      </div>

      <!-- My Topics Panel -->
      <div class="content panel-content hidden" id="topics-panel">
        <div class="col-left">
          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <h3>My Topics</h3>
              <div>
                <button class="btn ghost" id="exportTopicsData">Export Topic Data</button>
              </div>
            </div>

            <div class="view-only-notice">
              <i class="fas fa-eye"></i> View Only - Topics are loaded from system CSV data
            </div>

            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Topic Name</th>
                    <th>Subject</th>
                    <th>Average Score</th>
                    <th>Tests Taken</th>
                    <th>Difficulty Level</th>
                  </tr>
                </thead>
                <tbody id="topicsTable">
                  <tr>
                    <td colspan="5" style="text-align:center;color:var(--muted);padding:20px">
                      Loading topic data...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <aside class="right">
          <div class="small-card panel">
            <h4>Topic Performance</h4>
            <div class="chart-container small">
              <canvas id="topicPerformanceChart"></canvas>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Topic Insights</h4>
            <div style="margin-top:12px" id="topicInsights">
              <div style="text-align:center;color:var(--muted)">Loading insights...</div>
            </div>
          </div>
        </aside>
      </div>

      <!-- Graph Data Panel -->
      <div class="content panel-content hidden" id="graph-data-panel">
        <div class="col-left">
          <div class="panel">
            <h3>Performance Analytics</h3>
            <div class="tabs">
              <div class="tab active" data-tab="overview-graphs">Overview</div>
              <div class="tab" data-tab="factor-graphs">Factor Analysis</div>
              <div class="tab" data-tab="student-graphs">Student Comparison</div>
            </div>

            <div class="tab-content active" id="overview-graphs">
              <div class="chart-container">
                <h4>Performance Trend Over Time</h4>
                <canvas id="trendChart"></canvas>
                <div class="chart-report" id="trendReport">
                  Analyzing performance trends...
                </div>
              </div>
              
              <div class="widgets" style="margin-top:20px">
                <div class="panel">
                  <h4>Subject Performance</h4>
                  <div class="chart-container" style="height:250px">
                    <canvas id="subjectBarChart"></canvas>
                  </div>
                  <div class="chart-report" id="subjectReport">
                    Subject performance analysis...
                  </div>
                </div>
                <div class="panel">
                  <h4>Topic Performance</h4>
                  <div class="chart-container" style="height:250px">
                    <canvas id="topicBarChart"></canvas>
                  </div>
                  <div class="chart-report" id="topicReport">
                    Topic performance analysis...
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-content" id="factor-graphs">
              <div class="widgets">
                <div class="panel">
                  <h4>Day of Week Impact</h4>
                  <div class="chart-container" style="height:300px">
                    <canvas id="dayImpactChart"></canvas>
                  </div>
                  <div class="chart-report" id="dayImpactReport">
                    Day impact analysis...
                  </div>
                </div>
                <div class="panel">
                  <h4>Topic Difficulty Analysis</h4>
                  <div class="chart-container" style="height:300px">
                    <canvas id="topicDifficultyChart"></canvas>
                  </div>
                  <div class="chart-report" id="topicDifficultyReport">
                    Topic difficulty analysis...
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-content" id="student-graphs">
              <div class="panel">
                <h4>Student Performance Comparison</h4>
                <div class="chart-container" style="height:450px">
                  <canvas id="studentComparisonChart"></canvas>
                </div>
                <div class="chart-report" id="studentComparisonReport">
                  Student comparison analysis...
                </div>
              </div>
            </div>
          </div>
        </div>

        <aside class="right">
          <div class="small-card panel">
            <h4>Chart Controls</h4>
            <div style="margin-top:12px">
              <div class="form-group">
                <label>Time Range</label>
                <select class="form-control" id="timeRange">
                  <option value="30">Last 30 days</option>
                  <option value="90" selected>Last 90 days</option>
                  <option value="180">Last 6 months</option>
                  <option value="365">Last year</option>
                  <option value="0">All time</option>
                </select>
              </div>
              <div class="form-group">
                <label>Subject Filter</label>
                <select class="form-control" id="subjectFilter">
                  <option value="all">All Subjects</option>
                </select>
              </div>
              <button class="btn" style="width:100%" id="applyFilters">Apply Filters</button>
              <button class="btn ghost" style="width:100%;margin-top:12px" id="exportChartData">Export Chart Data</button>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Key Insights</h4>
            <div style="margin-top:12px" id="chartInsights">
              <div style="text-align:center;color:var(--muted)">Loading insights...</div>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Data Summary</h4>
            <div style="margin-top:12px" id="dataSummary">
              <div style="text-align:center;color:var(--muted)">Loading summary...</div>
            </div>
          </div>
        </aside>
      </div>

      <!-- Settings Panel -->
      <div class="content panel-content hidden" id="settings-panel">
        <div class="col-left">
          <div class="panel">
            <h3>Account Settings</h3>
            
            <!-- Profile Section -->
            <div class="profile-section">
              <div class="profile-avatar">{{ teacher.full_name[0] }}</div>
              <div class="profile-info">
                <h3>{{ teacher.full_name }}</h3>
                <p>{{ teacher.subjects }} Teacher</p>
                <span class="read-only-badge">READ ONLY</span>
              </div>
            </div>

            <!-- Account Settings -->
            <div class="settings-section">
              <h4>Account Preferences</h4>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Email Notifications</div>
                  <div class="description">Receive email alerts for performance updates</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Weekly Reports</div>
                  <div class="description">Automatically generate weekly performance reports</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Dark Mode</div>
                  <div class="description">Use dark theme (currently active)</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Display Settings -->
            <div class="settings-section">
              <h4>Display Preferences</h4>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Default Time Range</div>
                  <div class="description">Default period for performance charts</div>
                </div>
                <select class="form-control" style="width:120px">
                  <option>30 days</option>
                  <option selected>90 days</option>
                  <option>6 months</option>
                  <option>1 year</option>
                </select>
              </div>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Chart Animation</div>
                  <div class="description">Enable animations in charts and graphs</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" checked>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <!-- Data Management -->
            <div class="settings-section">
              <h4>Data Management</h4>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Auto-refresh Data</div>
                  <div class="description">Automatically refresh data every 30 minutes</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Export Format</div>
                  <div class="description">Default format for exported reports</div>
                </div>
                <select class="form-control" style="width:120px">
                  <option>Excel (.xlsx)</option>
                  <option selected>CSV (.csv)</option>
                  <option>PDF (.pdf)</option>
                </select>
              </div>
            </div>

            <!-- System Information -->
            <div class="settings-section">
              <h4>System Information</h4>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Data Source</div>
                  <div class="description">System CSV Files (Read Only)</div>
                </div>
                <span class="read-only-badge">READ ONLY</span>
              </div>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Last Data Update</div>
                  <div class="description" id="lastDataUpdate">Loading...</div>
                </div>
              </div>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">System Version</div>
                  <div class="description">Tutoring Analytics v2.1.0</div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div style="margin-top:32px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.05)">
              <button class="btn" style="width:100%;margin-bottom:12px">Save Settings</button>
              <button class="btn ghost" style="width:100%">Reset to Defaults</button>
            </div>
          </div>
        </div>

        <aside class="right">
          <div class="small-card panel">
            <h4>Quick Actions</h4>
            <div style="margin-top:12px">
              <button class="btn ghost" style="width:100%;margin-bottom:8px">
                <i class="fas fa-download"></i> Export All Data
              </button>
              <button class="btn ghost" style="width:100%;margin-bottom:8px">
                <i class="fas fa-sync"></i> Refresh Data
              </button>
              <button class="btn ghost" style="width:100%;margin-bottom:8px">
                <i class="fas fa-question-circle"></i> Help & Support
              </button>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Account Security</h4>
            <div style="margin-top:12px">
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Last Login</div>
                  <div class="description" id="lastLoginTime">Loading...</div>
                </div>
              </div>
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Account Status</div>
                  <div class="description" style="color:var(--accent)">Active</div>
                </div>
              </div>
              <button class="btn ghost" style="width:100%;margin-top:12px">
                <i class="fas fa-shield-alt"></i> Security Settings
              </button>
            </div>
          </div>

          <div class="small-card panel">
            <h4>Storage Usage</h4>
            <div style="margin-top:12px">
              <div class="settings-item">
                <div>
                  <div style="font-weight:600">Data Storage</div>
                  <div class="description">15.2 MB / 1 GB used</div>
                </div>
              </div>
              <div style="background:rgba(255,255,255,0.05);border-radius:4px;height:6px;margin:8px 0">
                <div style="background:var(--accent);width:15%;height:100%;border-radius:4px"></div>
              </div>
              <div style="font-size:12px;color:var(--muted);text-align:center">15% used</div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    let currentPerformanceData = null;
    let teacherCharts = {};
    let currentStudents = [];
    let currentSubjects = [];
    let currentTopics = [];

    document.addEventListener('DOMContentLoaded', function() {
        console.log('Teacher dashboard loading...');
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString();
        document.getElementById('lastLoginTime').textContent = new Date().toLocaleString();
        document.getElementById('lastDataUpdate').textContent = new Date().toLocaleString();
        
        loadOverviewData();
        setupNavigation();
        setupEventListeners();
        loadStudentsData();
        loadSubjectsData();
        loadTopicsData();
        
        // Auto-hide flash messages
        setTimeout(hideFlashMessages, 5000);
    });

    function setupNavigation() {
        document.querySelectorAll('.menu button').forEach(btn => {
            if (!btn.onclick) {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const panel = btn.getAttribute('data-panel');
                    document.querySelectorAll('.panel-content').forEach(p => p.classList.add('hidden'));
                    document.getElementById(`${panel}-panel`).classList.remove('hidden');
                    
                    loadPanelData(panel);
                });
            }
        });

        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabContainer = this.closest('.tabs');
                const tabContentId = this.getAttribute('data-tab');
                
                // Update active tab
                tabContainer.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content
                const contentContainer = tabContainer.nextElementSibling || tabContainer.parentNode;
                contentContainer.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tabContentId).classList.add('active');
            });
        });
    }

    function setupEventListeners() {
        document.getElementById('refreshBtn')?.addEventListener('click', loadOverviewData);
        document.getElementById('downloadReport')?.addEventListener('click', () => {
            exportReport('comprehensive');
        });
        
        // Export buttons
        document.querySelectorAll('.export-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const reportType = this.getAttribute('data-report');
                exportReport(reportType);
            });
        });

        document.getElementById('applyFilters')?.addEventListener('click', function() {
            loadOverviewData();
        });

        // Export data buttons
        document.getElementById('exportStudentsData')?.addEventListener('click', function() {
            exportReport('student_progress');
        });

        document.getElementById('exportSubjectsData')?.addEventListener('click', function() {
            exportReport('performance_summary');
        });

        document.getElementById('exportTopicsData')?.addEventListener('click', function() {
            exportReport('performance_summary');
        });

        document.getElementById('exportChartData')?.addEventListener('click', function() {
            exportReport('comprehensive');
        });
    }

    function loadStudentsData() {
        fetch('/teacher/students')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load students');
                }
                return response.json();
            })
            .then(students => {
                currentStudents = students;
                updateStudentsTable(students);
                updateStudentStats(students);
            })
            .catch(error => {
                console.error('Error loading students:', error);
                // Use sample data if API fails
                const sampleStudents = [
                    { id: 1, full_name: 'John Doe', student_id: 'S001', grade_level: 'Form 4', avg_grade: 85, test_count: 12, last_test_date: '2024-01-15' },
                    { id: 2, full_name: 'Jane Smith', student_id: 'S002', grade_level: 'Form 4', avg_grade: 78, test_count: 10, last_test_date: '2024-01-14' },
                    { id: 3, full_name: 'Michael Johnson', student_id: 'S003', grade_level: 'Form 4', avg_grade: 92, test_count: 15, last_test_date: '2024-01-16' },
                    { id: 4, full_name: 'Sarah Williams', student_id: 'S004', grade_level: 'Form 4', avg_grade: 74, test_count: 8, last_test_date: '2024-01-13' },
                    { id: 5, full_name: 'David Brown', student_id: 'S005', grade_level: 'Form 4', avg_grade: 88, test_count: 11, last_test_date: '2024-01-15' }
                ];
                currentStudents = sampleStudents;
                updateStudentsTable(sampleStudents);
                updateStudentStats(sampleStudents);
            });
    }

    function updateStudentsTable(students) {
        const tbody = document.getElementById('studentsTable');
        tbody.innerHTML = '';
        
        if (students.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align:center;color:var(--muted);padding:20px">
                        No students found in your classes.
                    </td>
                </tr>
            `;
            return;
        }
        
        students.forEach(student => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${student.full_name || 'N/A'}</td>
                <td>${student.student_id || 'N/A'}</td>
                <td>${student.grade_level || 'N/A'}</td>
                <td style="color: ${getScoreColor(student.avg_grade)}; font-weight: 600">
                    ${student.avg_grade || 0}%
                </td>
                <td>${student.test_count || 0}</td>
                <td>${student.last_test_date || 'N/A'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function updateStudentStats(students) {
        const totalStudents = students.length;
        const above80Count = students.filter(s => s.avg_grade >= 80).length;
        const below60Count = students.filter(s => s.avg_grade < 60).length;
        
        document.getElementById('totalStudentsCount').textContent = totalStudents;
        document.getElementById('above80Count').textContent = above80Count;
        document.getElementById('below60Count').textContent = below60Count;
        
        // Update KPI
        document.getElementById('kpi-students').textContent = totalStudents;
    }

    function loadSubjectsData() {
        fetch('/teacher/subjects')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load subjects');
                }
                return response.json();
            })
            .then(subjects => {
                currentSubjects = subjects;
                updateSubjectsTable(subjects);
            })
            .catch(error => {
                console.error('Error loading subjects:', error);
                // Use sample data if API fails
                const sampleSubjects = [
                    { name: 'Mathematics', avg_score: 78, total_tests: 45, top_topic: 'Algebra', trend: 'up' },
                    { name: 'English', avg_score: 82, total_tests: 38, top_topic: 'Composition', trend: 'stable' },
                    { name: 'Science', avg_score: 75, total_tests: 32, top_topic: 'Physics', trend: 'up' }
                ];
                currentSubjects = sampleSubjects;
                updateSubjectsTable(sampleSubjects);
            });
    }

    function updateSubjectsTable(subjects) {
        const tbody = document.getElementById('subjectsTable');
        tbody.innerHTML = '';
        
        if (subjects.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center;color:var(--muted);padding:20px">
                        No subjects found for your classes.
                    </td>
                </tr>
            `;
            return;
        }
        
        subjects.forEach(subject => {
            const row = document.createElement('tr');
            const trendIcon = subject.trend === 'up' ? '↗' : subject.trend === 'down' ? '↘' : '→';
            const trendColor = subject.trend === 'up' ? 'var(--accent)' : subject.trend === 'down' ? 'var(--danger)' : 'var(--muted)';
            
            row.innerHTML = `
                <td>${subject.name || 'N/A'}</td>
                <td style="color: ${getScoreColor(subject.avg_score)}; font-weight: 600">
                    ${subject.avg_score || 0}%
                </td>
                <td>${subject.total_tests || 0}</td>
                <td>${subject.top_topic || 'N/A'}</td>
                <td style="color: ${trendColor}">${trendIcon}</td>
            `;
            tbody.appendChild(row);
        });
        
        // Update KPI
        document.getElementById('kpi-subjects').textContent = subjects.length;
    }

    function loadTopicsData() {
        fetch('/teacher/topics')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load topics');
                }
                return response.json();
            })
            .then(topics => {
                currentTopics = topics;
                updateTopicsTable(topics);
            })
            .catch(error => {
                console.error('Error loading topics:', error);
                // Use sample data if API fails
                const sampleTopics = [
                    { name: 'Algebra', subject: 'Mathematics', avg_score: 72, test_count: 15, difficulty: 'High' },
                    { name: 'Geometry', subject: 'Mathematics', avg_score: 78, test_count: 12, difficulty: 'Medium' },
                    { name: 'Composition', subject: 'English', avg_score: 85, test_count: 10, difficulty: 'Low' },
                    { name: 'Grammar', subject: 'English', avg_score: 79, test_count: 8, difficulty: 'Medium' },
                    { name: 'Physics', subject: 'Science', avg_score: 74, test_count: 9, difficulty: 'High' }
                ];
                currentTopics = sampleTopics;
                updateTopicsTable(sampleTopics);
            });
    }

    function updateTopicsTable(topics) {
        const tbody = document.getElementById('topicsTable');
        tbody.innerHTML = '';
        
        if (topics.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center;color:var(--muted);padding:20px">
                        No topics found for your classes.
                    </td>
                </tr>
            `;
            return;
        }
        
        topics.forEach(topic => {
            const row = document.createElement('tr');
            const difficultyColor = topic.difficulty === 'High' ? 'var(--danger)' : 
                                  topic.difficulty === 'Medium' ? 'var(--warning)' : 'var(--accent)';
            
            row.innerHTML = `
                <td>${topic.name || 'N/A'}</td>
                <td>${topic.subject || 'N/A'}</td>
                <td style="color: ${getScoreColor(topic.avg_score)}; font-weight: 600">
                    ${topic.avg_score || 0}%
                </td>
                <td>${topic.test_count || 0}</td>
                <td style="color: ${difficultyColor}">${topic.difficulty || 'N/A'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    function getScoreColor(score) {
        if (score >= 80) return 'var(--accent)';
        if (score >= 70) return 'var(--accent-2)';
        if (score >= 60) return 'var(--warning)';
        return 'var(--danger)';
    }

    function loadOverviewData() {
        console.log('Loading overview data...');
        
        fetch('/api/performance-data')
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                console.log('Performance data loaded:', data);
                currentPerformanceData = data;
                initializeAllCharts(data);
                updateKPIs(data);
                updateSidebarData(data);
            })
            .catch(error => {
                console.error('Error loading performance data:', error);
                // Initialize with sample data if API fails
                const sampleData = getSampleData();
                initializeAllCharts(sampleData);
                updateKPIs(sampleData);
                updateSidebarData(sampleData);
            });
    }

    function initializeAllCharts(data) {
        console.log('Initializing charts with data:', data);
        
        try {
            // Main area chart
            createAreaChart(data);
            
            // Small charts
            createDayChart(data.day_averages);
            createTopicMiniChart(data.topic_averages);
            createSubjectMiniChart(data.subject_averages);
            
            // Graph Data Panel charts
            createTrendChart(data);
            createSubjectBarChart(data.subject_averages);
            createTopicBarChart(data.topic_averages);
            createDayImpactChart(data.day_averages);
            createTopicDifficultyChart(data.topic_averages);
            createStudentComparisonChart();
            
            // Additional charts
            createStudentPerformanceChart();
            createGradeDistributionChart();
            createSubjectPerformanceChart();
            createTopicPerformanceChart();
            
        } catch (error) {
            console.error('Error initializing charts:', error);
        }
    }

    // CHART CREATION FUNCTIONS

    function createAreaChart(data) {
        const ctx = document.getElementById('areaChart');
        if (!ctx) return;
        
        if (teacherCharts.areaChart) teacherCharts.areaChart.destroy();
        
        teacherCharts.areaChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates || ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Class Average',
                    data: data.scores || [72, 75, 78, 76],
                    tension: 0.4,
                    borderWidth: 2,
                    fill: true,
                    backgroundColor: 'rgba(110,231,183,0.1)',
                    borderColor: 'rgba(110,231,183,0.8)',
                    pointBackgroundColor: 'rgba(110,231,183,1)',
                    pointBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9aa4b2' }
                    },
                    y: {
                        ticks: { color: '#9aa4b2' },
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });
    }

    function createDayChart(dayData) {
        const ctx = document.getElementById('dayChart');
        if (!ctx) return;

        const data = dayData || { Monday: 75, Tuesday: 82, Wednesday: 78, Thursday: 80, Friday: 76 };
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (teacherCharts.dayChart) teacherCharts.dayChart.destroy();
        
        teacherCharts.dayChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: [
                        'rgba(96,165,250,0.8)',
                        'rgba(45,212,191,0.8)',
                        'rgba(249,115,22,0.8)',
                        'rgba(139,92,246,0.8)',
                        'rgba(236,72,153,0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '60%'
            }
        });

        // Update day report
        if (labels.length > 0) {
            const bestDay = labels[values.indexOf(Math.max(...values))];
            document.getElementById('dayReport').innerHTML = 
                `<strong>Best day:</strong> ${bestDay} (${Math.max(...values)}%)`;
        }
    }

    function createTopicMiniChart(topicData) {
        const ctx = document.getElementById('topicChart');
        if (!ctx) return;

        const data = topicData || { Algebra: 80, Geometry: 75, Statistics: 82 };
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (teacherCharts.topicChart) teacherCharts.topicChart.destroy();
        
        teacherCharts.topicChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: 'rgba(249,115,22,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }

    function createSubjectMiniChart(subjectData) {
        const ctx = document.getElementById('subjectChart');
        if (!ctx) return;

        const data = subjectData || { Mathematics: 78, English: 82, Science: 75 };
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (teacherCharts.subjectChart) teacherCharts.subjectChart.destroy();
        
        teacherCharts.subjectChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: 'rgba(96,165,250,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }

    function createTrendChart(data) {
        const ctx = document.getElementById('trendChart');
        if (!ctx) return;
        
        if (teacherCharts.trendChart) teacherCharts.trendChart.destroy();
        
        teacherCharts.trendChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.dates || ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
                datasets: [{
                    label: 'Performance Trend',
                    data: data.scores || [68, 72, 75, 71, 78],
                    tension: 0.4,
                    borderWidth: 2,
                    fill: true,
                    backgroundColor: 'rgba(96,165,250,0.08)',
                    borderColor: 'rgba(96,165,250,0.9)',
                    pointBackgroundColor: 'rgba(96,165,250,1)',
                    pointBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9aa4b2' }
                    },
                    y: {
                        ticks: { color: '#9aa4b2' },
                        grid: { color: 'rgba(255,255,255,0.05)' }
                    }
                }
            }
        });
    }

    function createSubjectBarChart(subjectData) {
        const ctx = document.getElementById('subjectBarChart');
        if (!ctx) return;

        const data = subjectData || { Mathematics: 78, English: 82, Science: 75 };
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (teacherCharts.subjectBarChart) teacherCharts.subjectBarChart.destroy();
        
        teacherCharts.subjectBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: values,
                    backgroundColor: [
                        'rgba(96,165,250,0.8)',
                        'rgba(45,212,191,0.8)',
                        'rgba(249,115,22,0.8)'
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    function createTopicBarChart(topicData) {
        const ctx = document.getElementById('topicBarChart');
        if (!ctx) return;

        const data = topicData || { Algebra: 72, Geometry: 78, Trigonometry: 75, Statistics: 82 };
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (teacherCharts.topicBarChart) teacherCharts.topicBarChart.destroy();
        
        teacherCharts.topicBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: values,
                    backgroundColor: 'rgba(139,92,246,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                indexAxis: 'y'
            }
        });
    }

    function createDayImpactChart(dayData) {
        const ctx = document.getElementById('dayImpactChart');
        if (!ctx) return;

        const data = dayData || { Monday: 75, Tuesday: 82, Wednesday: 78, Thursday: 80, Friday: 76 };
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (teacherCharts.dayImpactChart) teacherCharts.dayImpactChart.destroy();
        
        teacherCharts.dayImpactChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: values,
                    backgroundColor: 'rgba(16,185,129,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    function createTopicDifficultyChart(topicData) {
        const ctx = document.getElementById('topicDifficultyChart');
        if (!ctx) return;

        const data = topicData || { Algebra: 72, Geometry: 78, Trigonometry: 75, Statistics: 82 };
        const labels = Object.keys(data);
        const values = Object.values(data);

        if (teacherCharts.topicDifficultyChart) teacherCharts.topicDifficultyChart.destroy();
        
        teacherCharts.topicDifficultyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: values,
                    backgroundColor: 'rgba(245,158,11,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    function createStudentComparisonChart() {
        const ctx = document.getElementById('studentComparisonChart');
        if (!ctx) return;

        // Sample student data
        const students = ['Samuel', 'Ruth', 'Dennis', 'Mercy', 'Kevin'];
        const scores = [85, 78, 92, 74, 88];

        if (teacherCharts.studentComparisonChart) teacherCharts.studentComparisonChart.destroy();
        
        teacherCharts.studentComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: students,
                datasets: [{
                    label: 'Average Score',
                    data: scores,
                    backgroundColor: 'rgba(99,102,241,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    function createStudentPerformanceChart() {
        const ctx = document.getElementById('studentPerformanceChart');
        if (!ctx) return;

        if (teacherCharts.studentPerformanceChart) teacherCharts.studentPerformanceChart.destroy();
        
        teacherCharts.studentPerformanceChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Above 80%', '70-79%', '60-69%', 'Below 60%'],
                datasets: [{
                    data: [8, 12, 5, 2],
                    backgroundColor: [
                        'rgba(110,231,183,0.8)',
                        'rgba(96,165,250,0.8)',
                        'rgba(245,158,11,0.8)',
                        'rgba(239,68,68,0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '60%'
            }
        });
    }

    function createGradeDistributionChart() {
        const ctx = document.getElementById('gradeDistributionChart');
        if (!ctx) return;

        if (teacherCharts.gradeDistributionChart) teacherCharts.gradeDistributionChart.destroy();
        
        teacherCharts.gradeDistributionChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['A (90-100)', 'B (80-89)', 'C (70-79)', 'D (60-69)', 'F (0-59)'],
                datasets: [{
                    data: [15, 25, 35, 15, 10],
                    backgroundColor: [
                        'rgba(110,231,183,0.8)',
                        'rgba(96,165,250,0.8)',
                        'rgba(249,115,22,0.8)',
                        'rgba(251,191,36,0.8)',
                        'rgba(239,68,68,0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                cutout: '60%'
            }
        });
    }

    function createSubjectPerformanceChart() {
        const ctx = document.getElementById('subjectPerformanceChart');
        if (!ctx) return;

        if (teacherCharts.subjectPerformanceChart) teacherCharts.subjectPerformanceChart.destroy();
        
        teacherCharts.subjectPerformanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Mathematics', 'English', 'Science'],
                datasets: [{
                    label: 'Average Score',
                    data: [78, 82, 75],
                    backgroundColor: 'rgba(96,165,250,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    function createTopicPerformanceChart() {
        const ctx = document.getElementById('topicPerformanceChart');
        if (!ctx) return;

        if (teacherCharts.topicPerformanceChart) teacherCharts.topicPerformanceChart.destroy();
        
        teacherCharts.topicPerformanceChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Algebra', 'Geometry', 'Composition', 'Grammar', 'Physics'],
                datasets: [{
                    label: 'Average Score',
                    data: [72, 78, 85, 79, 74],
                    backgroundColor: 'rgba(139,92,246,0.8)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                indexAxis: 'y'
            }
        });
    }

    function updateKPIs(data) {
        // Update KPI cards
        const scores = data.scores || [];
        const avgScore = scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1) : '0';
        
        document.getElementById('kpi-avg').textContent = `${avgScore}%`;
        document.getElementById('kpi-tests').textContent = scores.length;
        document.getElementById('totalTests').textContent = scores.length;
        
        // Find best day
        const dayData = data.day_averages || {};
        if (Object.keys(dayData).length > 0) {
            const bestDay = Object.entries(dayData).reduce((a, b) => a[1] > b[1] ? a : b);
            document.getElementById('bestDay').textContent = bestDay[0];
        }
        
        // Find challenging topic
        const topicData = data.topic_averages || {};
        if (Object.keys(topicData).length > 0) {
            const challengingTopic = Object.entries(topicData).reduce((a, b) => a[1] < b[1] ? a : b);
            document.getElementById('challengingTopic').textContent = challengingTopic[0];
        }
    }

    function updateSidebarData(data) {
        // Update top students
        const topStudentsList = document.getElementById('topStudentsList');
        if (topStudentsList && currentStudents.length > 0) {
            const topStudents = currentStudents
                .sort((a, b) => (b.avg_grade || 0) - (a.avg_grade || 0))
                .slice(0, 3);
                
            topStudentsList.innerHTML = topStudents.map(student => `
                <div class="list-item">
                    <div>${student.full_name.split(' ')[0]}</div>
                    <div style="color:var(--accent)">${student.avg_grade || 'N/A'}%</div>
                </div>
            `).join('');
        }

        // Update recent tests
        const recentTests = document.getElementById('recent-tests');
        if (recentTests) {
            recentTests.innerHTML = `
                <div class="list-item">
                    <div>Mathematics Test</div>
                    <div style="font-size:12px;color:var(--muted)">2 days ago</div>
                </div>
                <div class="list-item">
                    <div>English Essay</div>
                    <div style="font-size:12px;color:var(--muted)">1 week ago</div>
                </div>
                <div class="list-item">
                    <div>Science Quiz</div>
                    <div style="font-size:12px;color:var(--muted)">2 weeks ago</div>
                </div>
            `;
        }

        // Update performance factors
        const performanceFactors = document.getElementById('performanceFactors');
        if (performanceFactors) {
            const dayData = data.day_averages || {};
            const bestDay = Object.entries(dayData).reduce((a, b) => a[1] > b[1] ? a : b, ['', 0]);
            
            performanceFactors.innerHTML = `
                <div class="list-item">
                    <div>Best Day</div>
                    <div style="color:var(--accent)">${bestDay[0]}</div>
                </div>
                <div class="list-item">
                    <div>Avg Improvement</div>
                    <div style="color:var(--accent)">+5.2%</div>
                </div>
            `;
        }

        // Update recommendations
        const systemRecommendations = document.getElementById('systemRecommendations');
        if (systemRecommendations) {
            systemRecommendations.innerHTML = `
                <div style="font-size:12px;color:var(--muted);margin-bottom:8px">
                    Focus on Algebra topics - students are struggling with this area.
                </div>
                <div style="font-size:12px;color:var(--muted);margin-bottom:8px">
                    Schedule important tests on Tuesday for better results.
                </div>
            `;
        }
    }

    function loadPanelData(panel) {
        console.log('Loading panel:', panel);
        if (panel === 'graph-data') {
            // Refresh data when switching to graph data panel
            loadOverviewData();
        } else if (panel === 'students') {
            // Refresh students data
            loadStudentsData();
        } else if (panel === 'subjects') {
            // Refresh subjects data
            loadSubjectsData();
        } else if (panel === 'topics') {
            // Refresh topics data
            loadTopicsData();
        }
    }

    function exportReport(reportType) {
        const url = `/api/export-report?type=${reportType}`;
        window.location.href = url;
    }

    function getSampleData() {
        return {
            dates: ['2024-01-01', '2024-01-08', '2024-01-15', '2024-01-22'],
            scores: [72, 75, 78, 76],
            day_averages: { Monday: 75, Tuesday: 82, Wednesday: 78, Thursday: 80, Friday: 76 },
            teacher_averages: { 'Kamau': 80, 'Moraa': 75, 'Njoroge': 78 },
            topic_averages: { Algebra: 72, Geometry: 78, Trigonometry: 75, Statistics: 82 },
            subject_averages: { Mathematics: 78, English: 82, Science: 75 }
        };
    }

    function hideFlashMessages() {
        document.querySelectorAll('.flash-message').forEach(msg => {
            msg.style.display = 'none';
        });
    }
  </script>
</body>
</html>
